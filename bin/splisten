#!/usr/bin/env ruby
# encoding: UTF-8
require 'listen'

puts WAITING_ICON = "â†»"

Listen.to('./app', './spec', filter: /\.rb$/) do |modified, added, removed|

  puts '...'
  files = (modified + added).map!{|f| f.sub(Dir.pwd + '/', '') }

  specs, sources = files.partition {|f| f =~ /_spec\.rb$/ }
  specs += sources.map{|f| f.sub('app', 'spec').sub('.rb', '_spec.rb') }

  specs.select! {|file| File.exist? file }

  system("rspec", *specs) if specs.any?

  puts WAITING_ICON
end
